<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Ghost Publisher - Cloud Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card-stat { 
            transition: transform 0.2s; 
            cursor: pointer;
        }
        .card-stat:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .action-card {
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .action-card:hover {
            border-color: var(--bs-primary);
            transform: scale(1.02);
        }
        .log-output {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-healthy { color: #28a745; }
        .status-degraded { color: #ffc107; }
        .status-unhealthy { color: #dc3545; }
        .production-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .cloud-notice {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-robot text-primary"></i> Reddit Ghost Publisher
                <small class="text-muted">Cloud Dashboard</small>
                <span class="production-badge ms-2">VERCEL</span>
            </span>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock"></i> <span id="currentTime"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 클라우드 배포 완료 안내 -->
        <div class="cloud-notice">
            <h4><i class="fas fa-cloud-upload-alt"></i> 클라우드 배포 완료!</h4>
            <p>API 서버가 Vercel Serverless Functions로 배포되었습니다. 24/7 운영이 가능합니다.</p>
            <div class="row mt-3">
                <div class="col-md-4">
                    <strong><i class="fas fa-server"></i> Serverless API</strong><br>
                    <small>자동 스케일링, 무제한 가용성</small>
                </div>
                <div class="col-md-4">
                    <strong><i class="fas fa-database"></i> Supabase DB</strong><br>
                    <small>PostgreSQL, 실시간 동기화</small>
                </div>
                <div class="col-md-4">
                    <strong><i class="fas fa-globe"></i> Global CDN</strong><br>
                    <small>전 세계 빠른 접근</small>
                </div>
            </div>
        </div>

        <!-- 시스템 상태 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-heartbeat"></i> 시스템 상태</h5>
                        <small>Vercel Serverless - Real-time Monitoring</small>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">로딩 중...</span>
                                </div>
                                <p class="mt-2">시스템 상태 확인 중...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="row mb-4" id="statsCards">
            <div class="col-md-3">
                <div class="card card-stat bg-primary text-white shadow">
                    <div class="card-body text-center">
                        <i class="fas fa-database fa-2x mb-2"></i>
                        <h3 id="totalPosts">-</h3>
                        <p class="mb-0">총 수집된 포스트</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat bg-info text-white shadow">
                    <div class="card-body text-center">
                        <i class="fas fa-robot fa-2x mb-2"></i>
                        <h3 id="aiProcessed">-</h3>
                        <p class="mb-0">AI 처리 완료</p>
                        <small id="pendingProcessing">대기: -개</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat bg-success text-white shadow">
                    <div class="card-body text-center">
                        <i class="fas fa-blog fa-2x mb-2"></i>
                        <h3 id="published">-</h3>
                        <p class="mb-0">Ghost 발행 완료</p>
                        <small id="pendingPublishing">대기: -개</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat bg-warning text-white shadow">
                    <div class="card-body text-center">
                        <i class="fas fa-percentage fa-2x mb-2"></i>
                        <h3 id="successRate">-</h3>
                        <p class="mb-0">성공률</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 파이프라인 제어 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-play-circle"></i> Cloud 파이프라인 제어</h5>
                        <small>Vercel Serverless Functions로 실행</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card action-card border-primary h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-download fa-3x text-primary mb-3"></i>
                                        <h6>Reddit 수집</h6>
                                        <p class="text-muted small">새로운 Reddit 포스트를 수집합니다</p>
                                        <button class="btn btn-primary" onclick="triggerCollection()">
                                            <i class="fas fa-play"></i> 수집 시작
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card action-card border-info h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-brain fa-3x text-info mb-3"></i>
                                        <h6>AI 처리</h6>
                                        <p class="text-muted small">수집된 포스트를 AI로 요약합니다</p>
                                        <button class="btn btn-info" onclick="processPost()">
                                            <i class="fas fa-robot"></i> AI 처리 시작
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card action-card border-success h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-rocket fa-3x text-success mb-3"></i>
                                        <h6>전체 파이프라인</h6>
                                        <p class="text-muted small">수집 → AI 처리 → Ghost 발행</p>
                                        <button class="btn btn-success" onclick="runFullPipeline()">
                                            <i class="fas fa-play"></i> 전체 실행
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 빠른 액션 및 모니터링 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-tools"></i> 빠른 액션</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshData()">
                                <i class="fas fa-sync"></i> 데이터 새로고침
                            </button>
                            <button class="btn btn-outline-success" onclick="viewGhostBlog()">
                                <i class="fas fa-external-link-alt"></i> Ghost 블로그 보기
                            </button>
                            <button class="btn btn-outline-warning" onclick="showLogs()">
                                <i class="fas fa-file-alt"></i> 시스템 로그
                            </button>
                            <button class="btn btn-outline-info" onclick="checkHealth()">
                                <i class="fas fa-heartbeat"></i> 헬스체크
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> 오늘 활동</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 class="text-primary" id="todayCollected">-</h4>
                                <p class="text-muted small">수집</p>
                            </div>
                            <div class="col-4">
                                <h4 class="text-info" id="todayProcessed">-</h4>
                                <p class="text-muted small">AI 처리</p>
                            </div>
                            <div class="col-4">
                                <h4 class="text-success" id="todayPublished">-</h4>
                                <p class="text-muted small">발행</p>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <small class="text-muted">
                                <i class="fas fa-server"></i> API 상태: <span id="apiStatus" class="badge bg-secondary">확인 중</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 로그 출력 -->
        <div class="row mb-4" id="logSection" style="display: none;">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal"></i> Cloud 시스템 로그
                            <button class="btn btn-sm btn-outline-light float-end" onclick="clearLogs()">
                                <i class="fas fa-trash"></i> 지우기
                            </button>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="logOutput" class="log-output p-3">
                            Vercel Serverless 로그가 여기에 표시됩니다...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloud 정보 -->
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-success shadow-sm">
                    <i class="fas fa-cloud"></i> 
                    <strong>Cloud 환경:</strong> 
                    Reddit Ghost Publisher가 Vercel Serverless Functions에서 실행되고 있습니다. 
                    24/7 자동 운영이 가능합니다.
                    <br><small class="text-muted">
                        API URL: <span id="apiUrl">배포 후 업데이트</span> |
                        Ghost 블로그: https://american-trends.ghost.io |
                        환경: Production | 
                        마지막 업데이트: <span id="lastUpdate">-</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 설정 - Vercel 배포 후 실제 URL로 변경 필요
        const API_BASE_URL = 'https://your-vercel-app.vercel.app';  // 배포 후 업데이트
        
        // 현재 시간 업데이트
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('ko-KR');
        }
        
        // 로그 추가
        function addLog(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
            
            logOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // 시스템 상태 확인
        async function checkSystemStatus() {
            try {
                addLog('Vercel API 서버 상태를 확인합니다...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const result = await response.json();
                
                if (result.success) {
                    displaySystemStatus(result.data);
                    addLog('Vercel API에서 시스템 상태를 가져왔습니다.', 'success');
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = 
                    '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Vercel API 서버 연결 확인 중... 배포가 완료되면 정상 작동합니다.</div>';
                addLog(`상태 확인 오류: ${error.message}`, 'error');
            }
        }
        
        function displaySystemStatus(data) {
            const status = data.overall_status;
            const statusClass = status === 'healthy' ? 'success' : status === 'degraded' ? 'warning' : 'danger';
            
            let servicesHtml = '';
            if (data.services) {
                servicesHtml = '<div class="row mt-3">';
                for (const [serviceName, serviceData] of Object.entries(data.services)) {
                    const serviceStatus = serviceData.status;
                    const serviceClass = serviceStatus === 'healthy' ? 'success' : serviceStatus === 'degraded' ? 'warning' : 'danger';
                    servicesHtml += `
                        <div class="col-md-2">
                            <div class="text-center">
                                <span class="badge bg-${serviceClass}">${serviceName}</span>
                            </div>
                        </div>
                    `;
                }
                servicesHtml += '</div>';
            }
            
            const statusHtml = `
                <div class="alert alert-${statusClass}">
                    <i class="fas fa-${status === 'healthy' ? 'check-circle' : 'exclamation-triangle'}"></i>
                    <strong>시스템 상태: ${status.toUpperCase()}</strong>
                    <br><small>환경: Vercel Serverless | Cloud 배포</small>
                    ${servicesHtml}
                </div>
            `;
            
            document.getElementById('systemStatus').innerHTML = statusHtml;
            document.getElementById('apiStatus').className = `badge bg-${statusClass}`;
            document.getElementById('apiStatus').textContent = status;
        }
        
        // 통계 업데이트
        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`);
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    
                    document.getElementById('totalPosts').textContent = stats.total_posts;
                    document.getElementById('aiProcessed').textContent = stats.ai_processed;
                    document.getElementById('published').textContent = stats.published;
                    document.getElementById('pendingProcessing').textContent = `대기: ${stats.total_posts - stats.ai_processed}개`;
                    document.getElementById('pendingPublishing').textContent = `대기: ${stats.ai_processed - stats.published}개`;
                    
                    document.getElementById('successRate').textContent = stats.success_rate + '%';
                    
                    document.getElementById('todayCollected').textContent = stats.collected_today;
                    document.getElementById('todayProcessed').textContent = stats.ai_processed;
                    document.getElementById('todayPublished').textContent = stats.published;
                    
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR');
                    
                    addLog('통계 데이터가 업데이트되었습니다.', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                addLog(`통계 업데이트 실패: ${error.message}`, 'error');
            }
        }
        
        // Reddit 수집 트리거
        async function triggerCollection() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 수집 중...';
            button.disabled = true;
            
            addLog('Vercel에서 Reddit 포스트 수집을 시작합니다...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/trigger/collect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        batch_size: 10,
                        subreddits: ['programming', 'technology', 'webdev']
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('수집 작업이 Serverless Function에서 시작되었습니다.', 'success');
                    addLog(`작업 ID: ${result.data.task_id}`, 'info');
                    setTimeout(updateStats, 3000);
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                addLog(`수집 트리거 오류: ${error.message}`, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // AI 포스트 처리
        async function processPost() {
            addLog('AI 처리는 별도의 워커가 필요합니다.', 'info');
            addLog('현재는 Serverless Function으로 트리거만 가능합니다.', 'info');
        }
        
        // 전체 파이프라인 실행
        async function runFullPipeline() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 실행 중...';
            button.disabled = true;
            
            addLog('Vercel에서 전체 파이프라인을 시작합니다...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/trigger/pipeline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        batch_size: 3
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('전체 파이프라인이 Serverless Function에서 시작되었습니다.', 'success');
                    addLog(`작업 ID: ${result.data.task_id}`, 'info');
                    addLog('수집 → AI 처리 → Ghost 발행 순서로 진행됩니다.', 'info');
                    setTimeout(updateStats, 5000);
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                addLog(`파이프라인 트리거 오류: ${error.message}`, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // 데이터 새로고침
        function refreshData() {
            addLog('데이터를 새로고침합니다...', 'info');
            checkSystemStatus();
            updateStats();
        }
        
        // Ghost 블로그 보기
        function viewGhostBlog() {
            addLog('Ghost 블로그를 새 창에서 엽니다...', 'info');
            window.open('https://american-trends.ghost.io', '_blank');
        }
        
        // 로그 표시/숨기기
        function showLogs() {
            const logSection = document.getElementById('logSection');
            logSection.style.display = logSection.style.display === 'none' ? 'block' : 'none';
            
            if (logSection.style.display === 'block') {
                addLog('Vercel Serverless 로그를 표시합니다...', 'info');
            }
        }
        
        // 로그 지우기
        function clearLogs() {
            document.getElementById('logOutput').innerHTML = 'Vercel 로그가 지워졌습니다...<br>';
        }
        
        // 헬스체크
        function checkHealth() {
            addLog('Vercel 헬스체크를 실행합니다...', 'info');
            checkSystemStatus();
        }
        
        // 초기화
        function init() {
            updateTime();
            checkSystemStatus();
            updateStats();
            addLog('Reddit Ghost Publisher Vercel Dashboard가 시작되었습니다.', 'success');
            addLog('Serverless Functions로 실행 중입니다.', 'info');
            
            // API URL 표시
            document.getElementById('apiUrl').textContent = API_BASE_URL;
            
            // 자동 업데이트 (30초마다)
            setInterval(() => {
                updateTime();
                updateStats();
            }, 30000);
            
            // 시간 업데이트 (1초마다)
            setInterval(updateTime, 1000);
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>