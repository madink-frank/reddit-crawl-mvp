{% extends "base.html" %}

{% block title %}ì œì–´ íŒ¨ë„ - Reddit Ghost Publisher{% endblock %}
{% block header %}ì œì–´ íŒ¨ë„{% endblock %}

{% block content %}
<div class="row">
    <!-- Reddit ìˆ˜ì§‘ ì œì–´ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download text-primary"></i> Reddit ìˆ˜ì§‘
                </h5>
            </div>
            <div class="card-body">
                <form id="collectForm">
                    <div class="mb-3">
                        <label for="subreddits" class="form-label">ì„œë¸Œë ˆë”§ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <input type="text" class="form-control" id="subreddits" 
                               value="programming,technology,webdev" 
                               placeholder="programming,technology,webdev">
                    </div>
                    <div class="mb-3">
                        <label for="batchSize" class="form-label">ë°°ì¹˜ í¬ê¸°</label>
                        <input type="number" class="form-control" id="batchSize" 
                               value="20" min="1" max="100">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="forceCollect">
                            <label class="form-check-label" for="forceCollect">
                                ê°•ì œ ì‹¤í–‰ (ì¤‘ë³µ ì²´í¬ ë¬´ì‹œ)
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play"></i> ìˆ˜ì§‘ ì‹œì‘
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- AI ì²˜ë¦¬ ì œì–´ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-brain text-info"></i> AI ì²˜ë¦¬
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <p class="text-muted">
                        ì²˜ë¦¬ë˜ì§€ ì•Šì€ í¬ìŠ¤íŠ¸ë¥¼ AIë¡œ ìš”ì•½í•˜ê³  íƒœê·¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                    </p>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="highScoreOnly" checked>
                        <label class="form-check-label" for="highScoreOnly">
                            ê³ ì ìˆ˜ í¬ìŠ¤íŠ¸ë§Œ ì²˜ë¦¬ (100ì  ì´ìƒ)
                        </label>
                    </div>
                </div>
                <button type="button" class="btn btn-info" onclick="triggerAIProcessing()">
                    <i class="fas fa-play"></i> AI ì²˜ë¦¬ ì‹œì‘
                </button>
                <button type="button" class="btn btn-outline-info" onclick="checkUnprocessed()">
                    <i class="fas fa-search"></i> ë¯¸ì²˜ë¦¬ í¬ìŠ¤íŠ¸ í™•ì¸
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ì „ì²´ íŒŒì´í”„ë¼ì¸ ì œì–´ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs text-success"></i> ì „ì²´ íŒŒì´í”„ë¼ì¸
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <p class="text-muted">
                        ìˆ˜ì§‘ â†’ AI ì²˜ë¦¬ â†’ Ghost ë°œí–‰ì˜ ì „ì²´ ê³¼ì •ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
                    </p>
                </div>
                <form id="pipelineForm">
                    <div class="mb-3">
                        <label for="pipelineSubreddits" class="form-label">ì„œë¸Œë ˆë”§</label>
                        <input type="text" class="form-control" id="pipelineSubreddits" 
                               value="programming,technology" 
                               placeholder="programming,technology">
                    </div>
                    <div class="mb-3">
                        <label for="pipelineBatchSize" class="form-label">ë°°ì¹˜ í¬ê¸°</label>
                        <input type="number" class="form-control" id="pipelineBatchSize" 
                               value="5" min="1" max="20">
                        <div class="form-text">ì „ì²´ íŒŒì´í”„ë¼ì¸ì€ ì‘ì€ ë°°ì¹˜ë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-play"></i> ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ì‹œìŠ¤í…œ ì œì–´ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-server text-warning"></i> ì‹œìŠ¤í…œ ì œì–´
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <p class="text-muted">
                        ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ë° ê¸°ë³¸ ì œì–´ ê¸°ëŠ¥
                    </p>
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="checkSystemStatus()">
                        <i class="fas fa-heartbeat"></i> ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="checkQueueStatus()">
                        <i class="fas fa-list"></i> í ìƒíƒœ í™•ì¸
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="viewLogs()">
                        <i class="fas fa-file-alt"></i> ë¡œê·¸ ë³´ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì‹¤í–‰ ê²°ê³¼ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-terminal"></i> ì‹¤í–‰ ê²°ê³¼
                </h5>
            </div>
            <div class="card-body">
                <div id="executionResults" class="bg-dark text-light p-3 rounded" style="min-height: 200px; font-family: monospace; font-size: 0.9rem;">
                    <div class="text-muted">ì‹¤í–‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// ì‹¤í–‰ ê²°ê³¼ í‘œì‹œ ì˜ì—­
const resultsDiv = document.getElementById('executionResults');

function addResult(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
    
    const resultLine = document.createElement('div');
    resultLine.innerHTML = `<span class="text-muted">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
    
    resultsDiv.appendChild(resultLine);
    resultsDiv.scrollTop = resultsDiv.scrollHeight;
    
    // ê²°ê³¼ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒ ì œê±°
    if (resultsDiv.children.length > 50) {
        resultsDiv.removeChild(resultsDiv.firstChild);
    }
}

// Reddit ìˆ˜ì§‘ í¼
document.getElementById('collectForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const subreddits = document.getElementById('subreddits').value.split(',').map(s => s.trim());
    const batchSize = parseInt(document.getElementById('batchSize').value);
    const force = document.getElementById('forceCollect').checked;
    
    addResult(`Reddit ìˆ˜ì§‘ ì‹œì‘: ${subreddits.join(', ')} (ë°°ì¹˜: ${batchSize})`);
    
    fetch('/api/trigger/collect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            subreddits: subreddits,
            batch_size: batchSize,
            force: force
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addResult(`âœ… ìˆ˜ì§‘ ì‘ì—… ì‹œì‘ë¨: ${data.data.message}`, 'success');
            addResult(`ì‘ì—… ID: ${data.data.task_id}`, 'info');
        } else {
            addResult(`âŒ ìˆ˜ì§‘ ì‹¤íŒ¨: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        addResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
    });
});

// ì „ì²´ íŒŒì´í”„ë¼ì¸ í¼
document.getElementById('pipelineForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const subreddits = document.getElementById('pipelineSubreddits').value.split(',').map(s => s.trim());
    const batchSize = parseInt(document.getElementById('pipelineBatchSize').value);
    
    addResult(`ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹œì‘: ${subreddits.join(', ')} (ë°°ì¹˜: ${batchSize})`);
    
    fetch('/api/trigger/pipeline', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            subreddits: subreddits,
            batch_size: batchSize
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addResult(`âœ… íŒŒì´í”„ë¼ì¸ ì‹œì‘ë¨: ${data.data.message}`, 'success');
            addResult(`ì‘ì—… ID: ${data.data.task_id}`, 'info');
        } else {
            addResult(`âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        addResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
    });
});

// AI ì²˜ë¦¬
function triggerAIProcessing() {
    addResult('AI ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘...');
    
    fetch('/api/trigger/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addResult(`âœ… AI ì²˜ë¦¬ ì‹œì‘ë¨: ${data.message}`, 'success');
        } else {
            addResult(`âŒ AI ì²˜ë¦¬ ì‹¤íŒ¨: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        addResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
    });
}

// ë¯¸ì²˜ë¦¬ í¬ìŠ¤íŠ¸ í™•ì¸
function checkUnprocessed() {
    addResult('ë¯¸ì²˜ë¦¬ í¬ìŠ¤íŠ¸ í™•ì¸ ì¤‘...');
    
    fetch('/api/stats')
    .then(response => response.json())
    .then(data => {
        if (data) {
            const unprocessed = data.total_posts - data.ai_processed;
            addResult(`ğŸ“Š ë¯¸ì²˜ë¦¬ í¬ìŠ¤íŠ¸: ${unprocessed}ê°œ (ì „ì²´: ${data.total_posts}, ì²˜ë¦¬ì™„ë£Œ: ${data.ai_processed})`, 'info');
        }
    })
    .catch(error => {
        addResult(`âŒ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
    });
}

// ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
function checkSystemStatus() {
    addResult('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì¤‘...');
    
    fetch('/api/status')
    .then(response => response.json())
    .then(data => {
        addResult(`ğŸ¥ ì‹œìŠ¤í…œ ìƒíƒœ: ${data.status}`, data.status === 'healthy' ? 'success' : 'error');
        
        if (data.services) {
            Object.entries(data.services).forEach(([name, info]) => {
                const status = info.status === 'healthy' ? 'âœ…' : info.status === 'degraded' ? 'âš ï¸' : 'âŒ';
                addResult(`  ${status} ${name}: ${info.status} (${info.response_time_ms}ms)`, 
                         info.status === 'healthy' ? 'success' : 'error');
            });
        }
    })
    .catch(error => {
        addResult(`âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
    });
}

// í ìƒíƒœ í™•ì¸
function checkQueueStatus() {
    addResult('í ìƒíƒœ í™•ì¸ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤...');
}

// ë¡œê·¸ ë³´ê¸°
function viewLogs() {
    window.open('/logs', '_blank');
}

// ì´ˆê¸° ë©”ì‹œì§€
addResult('ì œì–´ íŒ¨ë„ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ì›í•˜ëŠ” ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”.', 'success');
</script>
{% endblock %}